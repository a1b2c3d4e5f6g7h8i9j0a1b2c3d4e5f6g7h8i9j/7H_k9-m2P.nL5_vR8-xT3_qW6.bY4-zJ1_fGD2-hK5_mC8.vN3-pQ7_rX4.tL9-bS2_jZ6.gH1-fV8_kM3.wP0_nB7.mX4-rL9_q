name: iOS Build Capacitor Service

on:
  workflow_dispatch:
    inputs:
      # Repository
      repository_url:
        description: 'Your Capacitor app repository URL'
        required: true
        type: string
      
      repository_branch:
        description: 'Branch to build'
        required: false
        type: string
        default: 'main'
      
      is_private_repo:
        description: 'Is repository private?'
        required: true
        type: boolean
        default: true
      
      github_token:
        description: 'GitHub token (only for private repos)'
        required: false
        type: string

      version:
        description: 'Version (e.g., 1.0.0)'
        required: false
        type: string
        default: '1.0.0'
      
      build_number:
        description: 'Build number (leave empty for auto)'
        required: false
        type: string
      
      # Target Platform
      target_platform:
        description: 'Target devices'
        required: true
        type: choice
        options:
          - all_devices
          - iphone_and_ipad
          - iphone_only
          - ipad_only
          - macos_only
        default: 'all_devices'
      
      # Build Options
      build_mode:
        description: 'What to do?'
        required: true
        type: choice
        options:
          - build_only
          - publish_to_appstore
        default: 'build_only'
      
      npm_build_command:
        description: 'Build command'
        required: false
        type: string
        default: 'npm run build'
      
      # ========================================
      # ONE-TIME APPLE CREDENTIALS (JSON format)
      # ========================================
      apple_credentials:
        description: 'Apple credentials JSON (see README for format)'
        required: true
        type: string
      
      # Per-App: Provisioning Profile
      provisioning_profile_base64:
        description: 'Provisioning profile (.mobileprovision base64)'
        required: true
        type: string

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - name: Parse Apple Credentials
        id: apple
        env:
          APPLE_CREDS: ${{ inputs.apple_credentials }}
        run: |
          # Parse the JSON credentials (using env var to avoid shell quoting issues)
          
          # Extract values using jq
          echo "team_id=$(echo "$APPLE_CREDS" | jq -r '.team_id')" >> $GITHUB_OUTPUT
          echo "certificate_base64=$(echo "$APPLE_CREDS" | jq -r '.certificate_base64')" >> $GITHUB_OUTPUT
          echo "certificate_password=$(echo "$APPLE_CREDS" | jq -r '.certificate_password')" >> $GITHUB_OUTPUT
          echo "api_key_id=$(echo "$APPLE_CREDS" | jq -r '.api_key_id')" >> $GITHUB_OUTPUT
          echo "api_issuer_id=$(echo "$APPLE_CREDS" | jq -r '.api_issuer_id')" >> $GITHUB_OUTPUT
          echo "api_key_base64=$(echo "$APPLE_CREDS" | jq -r '.api_key_base64')" >> $GITHUB_OUTPUT
          
          echo "âœ… Apple credentials parsed successfully"
      
      - name: Clone App Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repository_url }}
          ref: ${{ inputs.repository_branch }}
          token: ${{ inputs.is_private_repo && inputs.github_token || github.token }}
          path: app
      
      - name: Read Capacitor Config
        id: capacitor
        working-directory: app
        run: |
          # 1. Identify Config File
          if [ -f "capacitor.config.json" ]; then
            echo "ðŸ“– Reading from capacitor.config.json"
            CONFIG_FILE="capacitor.config.json"
            IS_JSON=true
          elif [ -f "capacitor.config.ts" ]; then
            echo "ðŸ“– Reading from capacitor.config.ts"
            CONFIG_FILE="capacitor.config.ts"
            IS_JSON=false
          else
            echo "âŒ Error: No capacitor.config.json or capacitor.config.ts found!"
            exit 1
          fi

          # 2. Extract Values
          if [ "$IS_JSON" = true ]; then
            CONFIG_CONTENT=$(cat "$CONFIG_FILE")
            APP_NAME=$(echo "$CONFIG_CONTENT" | jq -r '.appName // empty')
            APP_ID=$(echo "$CONFIG_CONTENT" | jq -r '.appId // empty')
            WEB_DIR=$(echo "$CONFIG_CONTENT" | jq -r '.webDir // "www"')
          else
            # TypeScript regex extraction (basic)
            APP_NAME=$(sed -n "s/.*appName:[[:space:]]*['\"]\\([^'\"]*\\)['\"].*/\\1/p" "$CONFIG_FILE" | head -1)
            APP_ID=$(sed -n "s/.*appId:[[:space:]]*['\"]\\([^'\"]*\\)['\"].*/\\1/p" "$CONFIG_FILE" | head -1)
            WEB_DIR=$(sed -n "s/.*webDir:[[:space:]]*['\"]\\([^'\"]*\\)['\"].*/\\1/p" "$CONFIG_FILE" | head -1)
            
            # Default to www if not found
            if [ -z "$WEB_DIR" ]; then
              WEB_DIR="www"
            fi
          fi

          # 3. Validate
          if [ -z "$APP_NAME" ] || [ -z "$APP_ID" ]; then
            echo "âŒ Error: 'appName' or 'appId' missing in config!"
            exit 1
          fi

          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
          echo "bundle_id=$APP_ID" >> $GITHUB_OUTPUT
          echo "web_dir=$WEB_DIR" >> $GITHUB_OUTPUT
          echo "âœ… App: $APP_NAME ($APP_ID)"
          echo "ðŸ“‚ Web Dir: $WEB_DIR"
      
      - name: Detect Node Version
        id: node_version
        working-directory: app
        run: |
          echo "ðŸ” Detecting required Node.js version..."
          if [ -f "package.json" ]; then
            # Extract @capacitor/core version (dependencies or devDependencies)
            CAP_VER=$(jq -r '.dependencies["@capacitor/core"] // .devDependencies["@capacitor/core"] // empty' package.json)
            
            if [ -z "$CAP_VER" ]; then
              echo "âš ï¸ Could not find @capacitor/core in package.json. Defaulting to Node 20."
              NODE_VER="20"
            else
              echo "Found @capacitor/core: $CAP_VER"
              # Extract major version number (remove ^, ~, etc)
              MAJOR_VER=$(echo "$CAP_VER" | sed 's/[^0-9.]//g' | cut -d. -f1)
              
              if [ "$MAJOR_VER" -ge 8 ]; then
                echo "âš¡ Capacitor 8+ detected. Using Node 22."
                NODE_VER="22"
              elif [ "$MAJOR_VER" -eq 7 ] || [ "$MAJOR_VER" -eq 6 ]; then
                echo "âš¡ Capacitor 6/7 detected. Using Node 20."
                NODE_VER="20"
              elif [ "$MAJOR_VER" -le 5 ]; then
                echo "âš¡ Capacitor 5 or older detected. Using Node 18."
                NODE_VER="18"
              else
                # Fallback
                echo "âš ï¸ Unknown version version. Defaulting to Node 20."
                NODE_VER="20"
              fi
            fi
          else
            echo "âš ï¸ No package.json found. Defaulting to Node 20."
            NODE_VER="20"
          fi
          
          echo "version=$NODE_VER" >> $GITHUB_OUTPUT
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ steps.node_version.outputs.version }}
          cache: 'npm'
          cache-dependency-path: app/package-lock.json
      
      - name: Install Dependencies
        working-directory: app
        run: npm ci
      
      - name: Build Web App
        working-directory: app
        run: ${{ inputs.npm_build_command }}
      
      - name: Sync Capacitor iOS
        working-directory: app
        run: |
          WEB_DIR="${{ steps.capacitor.outputs.web_dir }}"
          echo "ðŸ” Checking web directory: $WEB_DIR"

          if [ ! -d "$WEB_DIR" ]; then
            echo "â„¹ï¸ Directory '$WEB_DIR' does not exist. Checking for build output..."
            
            # Search for common alternatives
            if [ -d "dist" ]; then
              echo "âœ… Found 'dist'. Moving to '$WEB_DIR'..."
              mv dist "$WEB_DIR"
            elif [ -d "build" ]; then
              echo "âœ… Found 'build'. Moving to '$WEB_DIR'..."
              mv build "$WEB_DIR"
            elif [ -d "public" ]; then
              echo "âœ… Found 'public'. Moving to '$WEB_DIR'..."
              mv public "$WEB_DIR"
            else
              echo "âŒ Could not find build output (dist, build, public). Validation failed."
              ls -F
              exit 1
            fi
          else
            echo "âœ… Web directory '$WEB_DIR' found."
          fi

          npx cap sync ios
      
      - name: Setup Ruby & Fastlane
        run: |
          gem install fastlane
          gem install cocoapods
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Import Certificate
        run: |
          CERT_PATH=$RUNNER_TEMP/cert.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          echo "${{ steps.apple.outputs.certificate_base64 }}" | base64 --decode > $CERT_PATH
          
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security import $CERT_PATH -P "${{ steps.apple.outputs.certificate_password }}" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
      
      - name: Import Provisioning Profile
        run: |
          PP_PATH=$RUNNER_TEMP/profile.mobileprovision
          echo "${{ inputs.provisioning_profile_base64 }}" | base64 --decode > $PP_PATH
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles
      
      - name: Update App Info
        working-directory: app/ios/App
        run: |
          /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName ${{ steps.capacitor.outputs.app_name }}" App/Info.plist || \
          /usr/libexec/PlistBuddy -c "Add :CFBundleDisplayName string ${{ steps.capacitor.outputs.app_name }}" App/Info.plist
          
          if [ -n "${{ inputs.build_number }}" ]; then
            /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ inputs.build_number }}" App/Info.plist
          fi
          
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ inputs.version }}" App/Info.plist
      
      - name: Configure Target Platform
        working-directory: app/ios/App
        run: |
          # Set target devices and build type based on selection
          IS_CATALYST="false"
          
          case "${{ inputs.target_platform }}" in
            "iphone_only")
              DESTINATION="generic/platform=iOS Simulator"
              DEVICES="1"  # iPhone only
              ;;
            "ipad_only")
              DESTINATION="generic/platform=iOS Simulator"
              DEVICES="2"  # iPad only
              ;;
            "iphone_and_ipad")
              DESTINATION="generic/platform=iOS Simulator"
              DEVICES="1,2"  # iPhone + iPad
              ;;
            "macos_only")
              DESTINATION="generic/platform=macOS,variant=Mac Catalyst"
              DEVICES="1,2"
              IS_CATALYST="true"
              ;;
            *)  # all_devices (default) - iPhone + iPad + Mac Catalyst
              DESTINATION="generic/platform=macOS,variant=Mac Catalyst"
              DEVICES="1,2"  # Universal + Mac
              IS_CATALYST="true"
              ;;
          esac
          
          # Determine export format based on build mode
          if [ "${{ inputs.build_mode }}" == "build_only" ]; then
            EXPORT_FORMAT="app"
          else
            EXPORT_FORMAT="ipa"
          fi
          
          echo "DESTINATION=$DESTINATION" >> $GITHUB_ENV
          echo "TARGET_DEVICES=$DEVICES" >> $GITHUB_ENV
          echo "IS_CATALYST=$IS_CATALYST" >> $GITHUB_ENV
          echo "EXPORT_FORMAT=$EXPORT_FORMAT" >> $GITHUB_ENV
          echo "Building for: ${{ inputs.target_platform }} (format: $EXPORT_FORMAT)"
      
      - name: Build App
        working-directory: app/ios/App
        run: |
          # Determine output format based on build mode
          if [ "${{ inputs.build_mode }}" == "build_only" ]; then
            # Build .app for simulator/VM testing
            
            if [ "${{ inputs.target_platform }}" == "all_devices" ]; then
              # ALL DEVICES: Build BOTH iOS Simulator AND macOS apps
              echo "ðŸ”¨ Building iOS Simulator app..."
              xcodebuild -workspace App.xcworkspace \
                -scheme App \
                -configuration Release \
                -destination "generic/platform=iOS Simulator" \
                -derivedDataPath build-simulator \
                CODE_SIGN_IDENTITY="-" \
                CODE_SIGNING_REQUIRED=NO \
                CODE_SIGNING_ALLOWED=NO
              
              # Find and zip iOS Simulator .app
              APP_PATH=$(find build-simulator -name "*.app" -type d | head -1)
              cp -R "$APP_PATH" ./App-iOS-Simulator.app
              zip -r App-iOS-Simulator.app.zip App-iOS-Simulator.app
              
              echo "ðŸ”¨ Building macOS (Mac Catalyst) app..."
              xcodebuild -workspace App.xcworkspace \
                -scheme App \
                -configuration Release \
                -destination "generic/platform=macOS,variant=Mac Catalyst" \
                -derivedDataPath build-macos \
                SUPPORTS_MACCATALYST=YES \
                CODE_SIGN_IDENTITY="-" \
                CODE_SIGNING_REQUIRED=NO \
                CODE_SIGNING_ALLOWED=NO
              
              # Find and zip macOS .app
              APP_PATH=$(find build-macos -name "*.app" -type d | head -1)
              cp -R "$APP_PATH" ./App-macOS.app
              zip -r App-macOS.app.zip App-macOS.app
              
              echo "âœ… Built both iOS Simulator and macOS apps"
              
            elif [ "$IS_CATALYST" == "true" ]; then
              # macos_only: Mac Catalyst build only
              xcodebuild -workspace App.xcworkspace \
                -scheme App \
                -configuration Release \
                -destination "$DESTINATION" \
                -derivedDataPath build \
                SUPPORTS_MACCATALYST=YES \
                CODE_SIGN_IDENTITY="-" \
                CODE_SIGNING_REQUIRED=NO \
                CODE_SIGNING_ALLOWED=NO
              
              APP_PATH=$(find build -name "*.app" -type d | head -1)
              cp -R "$APP_PATH" ./App.app
              zip -r App.app.zip App.app
              
            else
              # iPhone/iPad only: iOS Simulator build
              xcodebuild -workspace App.xcworkspace \
                -scheme App \
                -configuration Release \
                -destination "$DESTINATION" \
                -derivedDataPath build \
                CODE_SIGN_IDENTITY="-" \
                CODE_SIGNING_REQUIRED=NO \
                CODE_SIGNING_ALLOWED=NO
              
              APP_PATH=$(find build -name "*.app" -type d | head -1)
              cp -R "$APP_PATH" ./App.app
              zip -r App.app.zip App.app
            fi
            
          else
            # Build .ipa for App Store submission
            if [ "$IS_CATALYST" == "true" ]; then
              # Mac Catalyst for App Store
              fastlane run build_app \
                workspace:"App.xcworkspace" \
                scheme:"App" \
                catalyst_platform:"macos" \
                export_method:"app-store" \
                output_directory:"." \
                output_name:"App.ipa" \
                clean:true
            else
              # iOS for App Store
              fastlane run build_app \
                workspace:"App.xcworkspace" \
                scheme:"App" \
                export_method:"app-store" \
                output_directory:"." \
                output_name:"App.ipa" \
                clean:true
            fi
          fi
      
      - name: Upload to App Store
        if: inputs.build_mode == 'publish_to_appstore'
        working-directory: app/ios/App
        run: |
          # Save API key
          API_KEY_PATH=$RUNNER_TEMP/AuthKey.p8
          echo "${{ steps.apple.outputs.api_key_base64 }}" | base64 --decode > $API_KEY_PATH
          
          # Upload
          fastlane run upload_to_app_store \
            api_key_path:"$API_KEY_PATH" \
            api_key_id:"${{ steps.apple.outputs.api_key_id }}" \
            api_key_issuer_id:"${{ steps.apple.outputs.api_issuer_id }}" \
            ipa:"App.ipa" \
            skip_metadata:true \
            skip_screenshots:true \
            submit_for_review:false
      
      # Upload artifacts for all_devices (two separate artifacts)
      - name: Upload iOS Simulator Artifact
        if: inputs.build_mode == 'build_only' && inputs.target_platform == 'all_devices'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.capacitor.outputs.app_name }}-iOS-Simulator-${{ inputs.version }}
          path: app/ios/App/App-iOS-Simulator.app.zip
          retention-days: 30
      
      - name: Upload macOS Artifact
        if: inputs.build_mode == 'build_only' && inputs.target_platform == 'all_devices'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.capacitor.outputs.app_name }}-macOS-${{ inputs.version }}
          path: app/ios/App/App-macOS.app.zip
          retention-days: 30
      
      # Upload single artifact for other targets
      - name: Upload App Artifact
        if: inputs.build_mode == 'build_only' && inputs.target_platform != 'all_devices'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.capacitor.outputs.app_name }}-${{ inputs.target_platform }}-${{ inputs.version }}
          path: app/ios/App/App.app.zip
          retention-days: 30
      
      - name: Build Summary
        run: |
          echo "## âœ… Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "**App:** ${{ steps.capacitor.outputs.app_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Bundle ID:** ${{ steps.capacitor.outputs.bundle_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** ${{ inputs.target_platform }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.build_mode }}" == "build_only" ]; then
            if [ "${{ inputs.target_platform }}" == "all_devices" ]; then
              echo "ðŸ“¦ **Two artifacts available:**" >> $GITHUB_STEP_SUMMARY
              echo "- ðŸ“± iOS Simulator .app (drag into Simulator)" >> $GITHUB_STEP_SUMMARY
              echo "- ðŸ–¥ï¸ macOS .app (double-click to run)" >> $GITHUB_STEP_SUMMARY
            else
              echo "ðŸ“¦ Download .app from Artifacts (unzip to use)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "ðŸš€ Uploaded to App Store Connect" >> $GITHUB_STEP_SUMMARY
          fi
