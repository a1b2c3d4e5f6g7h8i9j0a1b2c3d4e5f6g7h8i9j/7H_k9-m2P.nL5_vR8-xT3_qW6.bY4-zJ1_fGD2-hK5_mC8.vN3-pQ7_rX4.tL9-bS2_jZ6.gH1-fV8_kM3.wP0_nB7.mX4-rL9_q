name: iOS Build Service

on:
  workflow_dispatch:
    inputs:
      # Repository
      repository_url:
        description: 'Your Capacitor app repository URL'
        required: true
        type: string
      
      repository_branch:
        description: 'Branch to build'
        required: false
        type: string
        default: 'main'
      
      is_private_repo:
        description: 'Is repository private?'
        required: true
        type: boolean
        default: false
      
      github_token:
        description: 'GitHub token (only for private repos)'
        required: false
        type: string
      
      # App Configuration
      app_name:
        description: 'App display name'
        required: true
        type: string
      
      bundle_id:
        description: 'Bundle ID (e.g., com.company.app)'
        required: true
        type: string
      
      version:
        description: 'Version (e.g., 1.0.0)'
        required: false
        type: string
        default: '1.0.0'
      
      build_number:
        description: 'Build number (leave empty for auto)'
        required: false
        type: string
      
      # Target Platform
      target_platform:
        description: 'Target devices'
        required: true
        type: choice
        options:
          - all_devices
          - iphone_and_ipad
          - iphone_only
          - ipad_only
        default: 'all_devices'
      
      # Build Options
      build_mode:
        description: 'What to do?'
        required: true
        type: choice
        options:
          - build_only
          - publish_to_appstore
        default: 'build_only'
      
      npm_build_command:
        description: 'Build command'
        required: false
        type: string
        default: 'npm run build'
      
      # ========================================
      # ONE-TIME APPLE CREDENTIALS (JSON format)
      # ========================================
      apple_credentials:
        description: 'Apple credentials JSON (see README for format)'
        required: true
        type: string
      
      # Per-App: Provisioning Profile
      provisioning_profile_base64:
        description: 'Provisioning profile (.mobileprovision base64)'
        required: true
        type: string

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - name: Parse Apple Credentials
        id: apple
        run: |
          # Parse the JSON credentials
          CREDS='${{ inputs.apple_credentials }}'
          
          # Extract values using jq
          echo "team_id=$(echo "$CREDS" | jq -r '.team_id')" >> $GITHUB_OUTPUT
          echo "certificate_base64=$(echo "$CREDS" | jq -r '.certificate_base64')" >> $GITHUB_OUTPUT
          echo "certificate_password=$(echo "$CREDS" | jq -r '.certificate_password')" >> $GITHUB_OUTPUT
          echo "api_key_id=$(echo "$CREDS" | jq -r '.api_key_id')" >> $GITHUB_OUTPUT
          echo "api_issuer_id=$(echo "$CREDS" | jq -r '.api_issuer_id')" >> $GITHUB_OUTPUT
          echo "api_key_base64=$(echo "$CREDS" | jq -r '.api_key_base64')" >> $GITHUB_OUTPUT
          
          echo "âœ… Apple credentials parsed successfully"
      
      - name: Clone App Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repository_url }}
          ref: ${{ inputs.repository_branch }}
          token: ${{ inputs.is_private_repo && inputs.github_token || github.token }}
          path: app
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json
      
      - name: Install Dependencies
        working-directory: app
        run: npm ci
      
      - name: Build Web App
        working-directory: app
        run: ${{ inputs.npm_build_command }}
      
      - name: Sync Capacitor iOS
        working-directory: app
        run: npx cap sync ios
      
      - name: Setup Ruby & Fastlane
        run: |
          gem install fastlane
          gem install cocoapods
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Import Certificate
        run: |
          CERT_PATH=$RUNNER_TEMP/cert.p12
          KEYCHAIN_PATH=$RUNNER_TEMP/app.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          echo "${{ steps.apple.outputs.certificate_base64 }}" | base64 --decode > $CERT_PATH
          
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security import $CERT_PATH -P "${{ steps.apple.outputs.certificate_password }}" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
      
      - name: Import Provisioning Profile
        run: |
          PP_PATH=$RUNNER_TEMP/profile.mobileprovision
          echo "${{ inputs.provisioning_profile_base64 }}" | base64 --decode > $PP_PATH
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles
      
      - name: Update App Info
        working-directory: app/ios/App
        run: |
          /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName ${{ inputs.app_name }}" App/Info.plist || \
          /usr/libexec/PlistBuddy -c "Add :CFBundleDisplayName string ${{ inputs.app_name }}" App/Info.plist
          
          if [ -n "${{ inputs.build_number }}" ]; then
            /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${{ inputs.build_number }}" App/Info.plist
          fi
          
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString ${{ inputs.version }}" App/Info.plist
      
      - name: Configure Target Platform
        working-directory: app/ios/App
        run: |
          # Set target devices based on selection
          case "${{ inputs.target_platform }}" in
            "iphone_only")
              DESTINATION="generic/platform=iOS"
              DEVICES="1"  # iPhone only
              ;;
            "ipad_only")
              DESTINATION="generic/platform=iOS"
              DEVICES="2"  # iPad only
              ;;
            "iphone_and_ipad")
              DESTINATION="generic/platform=iOS"
              DEVICES="1,2"  # iPhone + iPad
              ;;
            *)  # all_devices (default) - iPhone + iPad + Mac
              DESTINATION="generic/platform=macOS,variant=Mac Catalyst"
              DEVICES="1,2"  # Universal + Mac
              ;;
          esac
          
          echo "DESTINATION=$DESTINATION" >> $GITHUB_ENV
          echo "TARGET_DEVICES=$DEVICES" >> $GITHUB_ENV
          echo "Building for: ${{ inputs.target_platform }}"
      
      - name: Build iOS App
        working-directory: app/ios/App
        run: |
          if [ "${{ inputs.target_platform }}" == "all_devices" ]; then
            # Build for Mac Catalyst (includes iPhone + iPad + Mac)
            fastlane run build_app \
              workspace:"App.xcworkspace" \
              scheme:"App" \
              catalyst_platform:"macos" \
              export_method:"app-store" \
              output_directory:"." \
              output_name:"App.ipa" \
              clean:true
          else
            # Build for iOS only (iPhone/iPad)
            fastlane run build_app \
              workspace:"App.xcworkspace" \
              scheme:"App" \
              export_method:"app-store" \
              output_directory:"." \
              output_name:"App.ipa" \
              clean:true
          fi
      
      - name: Upload to App Store
        if: inputs.build_mode == 'publish_to_appstore'
        working-directory: app/ios/App
        run: |
          # Save API key
          API_KEY_PATH=$RUNNER_TEMP/AuthKey.p8
          echo "${{ steps.apple.outputs.api_key_base64 }}" | base64 --decode > $API_KEY_PATH
          
          # Upload
          fastlane run upload_to_app_store \
            api_key_path:"$API_KEY_PATH" \
            api_key_id:"${{ steps.apple.outputs.api_key_id }}" \
            api_key_issuer_id:"${{ steps.apple.outputs.api_issuer_id }}" \
            ipa:"App.ipa" \
            skip_metadata:true \
            skip_screenshots:true \
            submit_for_review:false
      
      - name: Upload IPA Artifact
        if: inputs.build_mode == 'build_only'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.app_name }}-${{ inputs.target_platform }}-${{ inputs.version }}
          path: app/ios/App/App.ipa
          retention-days: 30
      
      - name: Build Summary
        run: |
          echo "## âœ… Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "**App:** ${{ inputs.app_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Bundle ID:** ${{ inputs.bundle_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Platform:** ${{ inputs.target_platform }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.build_mode }}" == "build_only" ]; then
            echo "ðŸ“¦ Download IPA from Artifacts" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸš€ Uploaded to App Store Connect" >> $GITHUB_STEP_SUMMARY
          fi
